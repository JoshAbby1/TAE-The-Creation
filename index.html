<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TAE Creations — Image Generator</title>
  <style>
    :root { --bg:#0b0b0c; --panel:#151518; --text:#e8e8ea; --muted:#9aa0a6; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 860px; margin: 28px auto; padding: 0 16px; }
    .card { background: var(--panel); border:1px solid #222328; border-radius: 14px; padding: 18px; }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p.note { margin: 6px 0 16px; color: var(--muted); }
    textarea { width:100%; min-height: 96px; padding:12px; border-radius: 10px; border:1px solid #2a2b31; background:#0f0f12; color:var(--text); }
    .row { display:flex; gap:14px; flex-wrap: wrap; align-items: center; margin: 12px 0; }
    .uploader { flex:1 1 260px; padding:16px; border:1px dashed #2a2b31; border-radius: 10px; background:#0f0f12; text-align:center; color:var(--muted); cursor:pointer; }
    .uploader input { display:none; }
    .preview { margin-top:10px; max-height:160px; border-radius:8px; display:none; }
    button { appearance:none; border:0; background:#4c78ff; color:white; padding:12px 16px; border-radius:10px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .out { margin-top:16px; }
    .out img { max-width:100%; border-radius: 12px; display:block; }
    .bar { display:flex; align-items:center; gap:10px; }
    .muted { color: var(--muted); font-size: 13px; }
    .err { color:#ff6b6b; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>TAE Creations — Image Generator</h1>
      <p class="note">Enter a prompt, optionally upload a reference image, then generate.</p>

      <label for="prompt" class="muted">Prompt</label>
      <textarea id="prompt" placeholder="ultra-realistic portrait, soft studio lighting"></textarea>

      <div class="row">
        <label class="uploader" id="dropper">
          <input type="file" id="file" accept="image/*" />
          <div id="dropText">Click to upload or drop an image (optional)</div>
          <img id="preview" class="preview" alt="preview" />
        </label>
        <div class="bar">
          <button id="go">Generate</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <div class="out" id="out"></div>
    </div>
  </div>

  <script>
    const goBtn = document.getElementById('go');
    const fileInput = document.getElementById('file');
    const dropper = document.getElementById('dropper');
    const dropText = document.getElementById('dropText');
    const preview = document.getElementById('preview');
    const promptEl = document.getElementById('prompt');
    const statusEl = document.getElementById('status');
    const outEl = document.getElementById('out');

    ['dragenter','dragover'].forEach(ev => {
      dropper.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropper.style.borderColor = '#4c78ff'; });
    });
    ['dragleave','drop'].forEach(ev => {
      dropper.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropper.style.borderColor = '#2a2b31'; });
    });
    dropper.addEventListener('click', () => fileInput.click());
    dropper.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if (f) { fileInput.files = e.dataTransfer.files; renderPreview(f); }
    });
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (f) renderPreview(f);
    });

    function renderPreview(file) {
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = 'block';
        dropText.textContent = file.name;
      };
      reader.readAsDataURL(file);
    }

    async function toBase64(file) {
      if (!file) return null;
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;               // data:image/png;base64,....
          const base64 = String(dataUrl).split(',')[1] || '';
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    goBtn.addEventListener('click', async () => {
      outEl.innerHTML = '';
      statusEl.textContent = 'Generating…';
      goBtn.disabled = true;

      try {
        const prompt = promptEl.value?.trim() || '';
        const file = fileInput.files?.[0] || null;
        const imageBase64 = file ? await toBase64(file) : null;

        if (!prompt && !imageBase64) {
          statusEl.textContent = '';
          outEl.innerHTML = '<div class="err">Please enter a prompt or upload an image.</div>';
          goBtn.disabled = false;
          return;
        }

        const res = await fetch('/api/image-generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, imageBase64 }),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data?.imageUrl) {
          statusEl.textContent = '';
          outEl.innerHTML = '<div class="err">Generation failed. Please try again later.</div>';
          goBtn.disabled = false;
          return;
        }

        const img = new Image();
        img.src = data.imageUrl;
        img.alt = 'generated';
        outEl.innerHTML = '';
        outEl.appendChild(img);

        const a = document.createElement('a');
        a.href = data.imageUrl;
        a.download = 'tae-image.png';
        a.textContent = 'Download';
        a.style.display = 'inline-block';
        a.style.marginTop = '10px';
        outEl.appendChild(a);

        statusEl.textContent = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = '';
        outEl.innerHTML = '<div class="err">Generation failed. Please try again later.</div>';
      } finally {
        goBtn.disabled = false;
      }
    });
  </script>
</body>
</html>

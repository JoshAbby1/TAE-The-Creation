<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>TAE Creations ‚Äî Image</title>
  <style>
    :root { --bg:#0b0b0c; --panel:#151517; --text:#f4f4f5; --muted:#9aa0a6; --brand:#7c5cff; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width: 860px; margin: 24px auto; padding: 0 16px 48px; }
    h1 { font-size: 24px; margin: 0 0 12px; letter-spacing:.2px; }
    p.muted { color: var(--muted); margin-top: 4px; }
    textarea, input[type="text"] {
      width: 100%; background: var(--panel); color: var(--text);
      border: 1px solid #222326; border-radius: 10px; padding: 14px 14px; outline: none;
    }
    textarea { min-height: 120px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; }
    .controls { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top:12px;}
    .small { font-size: 13px; color: var(--muted); }
    .btn {
      width:100%; appearance:none; border:0; border-radius:12px; padding:14px 16px;
      font-weight:600; color:#fff; background: linear-gradient(135deg,#8a5cff,#5a62ff);
      cursor:pointer;
    }
    .btn[disabled]{opacity:.6; cursor:default;}
    .panel {
      background: var(--panel); border:1px solid #222326; border-radius:12px; padding:12px;
    }
    .previewBox { width:100%; aspect-ratio: 9/16; border-radius: 12px; overflow:hidden; background:#0f0f10; display:flex; align-items:center; justify-content:center; border:1px dashed #2a2b2f; }
    .previewBox img { width:100%; height:100%; object-fit: cover; }
    .hint { font-size: 12px; color: var(--muted); margin-top:6px; }
    .result { margin-top: 18px; }
    .result img { width:100%; border-radius: 14px; display:block; }
    .pill { font-size:12px; padding:6px 10px; background:#1b1c20; border:1px solid #26272b; border-radius:999px; display:inline-flex; align-items:center; gap:8px;}
    input[type="file"] { display:none; }
    .fileBtn { display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid #26272b; background:#15161a; color:#e7e7ea; cursor:pointer; }
    .row-2col { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:720px){ .controls{grid-template-columns:1fr;} .row-2col{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TAE Creations ‚Äî Image</h1>
    <p class="muted">Upload a photo (optional), add a prompt, and generate a 9:16 image. Realistic mode on by default.</p>

    <div class="row">
      <textarea id="prompt" placeholder="Describe the change... e.g. 'holding a Red Bull, candid street photo, shallow depth of field'"></textarea>

      <div class="controls">
        <label class="panel">
          <div class="small">Negative prompt (optional)</div>
          <input id="neg" type="text" placeholder="cartoon, painting, anime, deformed, blurry, extra fingers" />
        </label>

        <label class="panel" style="display:grid; gap:8px;">
          <div class="small" style="display:flex; justify-content:space-between;">
            <span>Image influence (strength)</span>
            <span><span id="strengthVal">0.65</span></span>
          </div>
          <input id="strength" type="range" min="0.2" max="0.95" step="0.01" value="0.65" oninput="document.getElementById('strengthVal').textContent=this.value" />
          <div class="hint">Lower = more faithful to the uploaded photo</div>
        </label>
      </div>

      <div class="panel">
        <div class="row-2col" style="align-items:start;">
          <div>
            <label class="fileBtn">
              <input id="file" type="file" accept="image/*" />
              üì∑ Choose Photo
            </label>
            <div class="hint">9:16 output. Large files are auto-resized client-side.</div>
          </div>
          <div class="pill">Aspect ratio: 9:16</div>
        </div>

        <div class="previewBox" id="previewBox"><span class="small">No image selected</span></div>
        <div class="hint" id="fileInfo"></div>
      </div>

      <button id="go" class="btn">Generate</button>
      <div class="small" id="status"></div>

      <div class="result" id="result"></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const previewBox = document.getElementById('previewBox');
    const fileInfo = document.getElementById('fileInfo');
    const statusEl = document.getElementById('status');
    const goBtn = document.getElementById('go');

    // Hold the base64 we‚Äôll send to the API
    let imageBase64 = "";

    // --- helpers ---
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function downscaleTo916(dataUrl, maxH=1365) {
      // force 9:16 canvas for i2i
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const targetW = Math.round(maxH * 9/16);
          const targetH = maxH;

          const cnv = document.createElement('canvas');
          cnv.width = targetW; cnv.height = targetH;
          const ctx = cnv.getContext('2d');

          // cover fit (center crop)
          const srcAR = img.width / img.height;
          const dstAR = targetW / targetH;

          let sw, sh, sx, sy;
          if (srcAR > dstAR) {
            // source wider ‚Äî crop sides
            sh = img.height;
            sw = sh * dstAR;
            sx = (img.width - sw)/2;
            sy = 0;
          } else {
            // source taller ‚Äî crop top/bottom
            sw = img.width;
            sh = sw / dstAR;
            sx = 0;
            sy = (img.height - sh)/2;
          }

          ctx.drawImage(img, sx, sy, sw, sh, 0, 0, targetW, targetH);
          resolve(cnv.toDataURL('image/jpeg', 0.92));
        };
        img.src = dataUrl;
      });
    }

    // Preview + prepare base64 on choose
    fileInput.addEventListener('change', async () => {
      const file = fileInput.files?.[0];
      if (!file) return;

      fileInfo.textContent = `${file.name} (${Math.round(file.size/1024)} KB)`;
      statusEl.textContent = 'Preparing image...';

      const raw = await readFileAsDataURL(file);
      const sized = await downscaleTo916(raw, 1365);  // ~9:16 portrait
      imageBase64 = sized;

      // preview
      previewBox.innerHTML = '';
      const img = new Image();
      img.src = sized;
      previewBox.appendChild(img);

      statusEl.textContent = '';
    });

    async function generate() {
      const prompt = document.getElementById('prompt').value || '';
      const negative = document.getElementById('neg').value || '';
      const strength = parseFloat(document.getElementById('strength').value);

      statusEl.textContent = 'Generating...';
      goBtn.disabled = true;

      try {
        const resp = await fetch('/api/image-generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt,
            imageBase64: imageBase64 || null,
            // Pass ‚Äúquality knobs‚Äù to your server (your API can ignore unknown fields)
            params: {
              width:  768,     // 9:16 portrait
              height: 1365,
              guidance_scale: 4.5,
              num_inference_steps: 28,
              strength,
              negative_prompt: negative
            }
          })
        });

        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(`Server error: ${t}`);
        }

        const data = await resp.json();
        const out = data.imageUrl || data.image || '';
        if (!out) throw new Error('No image returned');

        document.getElementById('result').innerHTML =
          `<img alt="result" src="${out}" />`;

        statusEl.textContent = 'Done.';
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Generation failed. Please try again.';
      } finally {
        goBtn.disabled = false;
      }
    }

    document.getElementById('go').addEventListener('click', generate);
  </script>
</body>
</html>

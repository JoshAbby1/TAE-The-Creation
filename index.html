<script>
  const form = document.getElementById("form");
  const promptInput = document.getElementById("prompt");
  const fileInput = document.getElementById("file");
  const out = document.getElementById("out");
  const btn = document.getElementById("btn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    btn.disabled = true;
    out.textContent = "Generating...";

    // read file -> base64 (with data: prefix)
    let imageBase64 = "";
    const file = fileInput.files?.[0];
    if (file) {
      const bytes = await file.arrayBuffer();
      const b64 = btoa(String.fromCharCode(...new Uint8Array(bytes)));
      imageBase64 = `data:${file.type};base64,${b64}`;
    }

    const prompt = promptInput.value || "";

    const resp = await fetch("/api/image-generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, imageBase64 }),
    });

    if (!resp.ok) {
      out.textContent = "Generation failed. Please try again.";
      btn.disabled = false;
      return;
    }

    const { imageUrl } = await resp.json();
    out.innerHTML = `<img src="${imageUrl}" style="max-width:100%;border-radius:8px" />`;
    btn.disabled = false;
  });
</script>
